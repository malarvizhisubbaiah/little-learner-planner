name: ğŸ“š Daily Lesson Plan

on:
  schedule:
    # Runs every day at 6:00 AM UTC (adjust to your timezone)
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      day_number:
        description: 'Lesson day number (e.g., 1, 2, 3...)'
        required: false
        default: ''
      focus_topic:
        description: 'Optional focus topic (reading, phonics, or maths)'
        required: false
        default: ''

permissions:
  issues: write
  contents: read

jobs:
  create-lesson-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate day number
        id: day
        run: |
          if [ -n "${{ github.event.inputs.day_number }}" ]; then
            echo "number=${{ github.event.inputs.day_number }}" >> $GITHUB_OUTPUT
          else
            # Calculate days since first lesson
            start_date="2026-02-17"
            current_date=$(date +%Y-%m-%d)
            days=$(( ($(date -d "$current_date" +%s) - $(date -d "$start_date" +%s)) / 86400 + 1 ))
            echo "number=$days" >> $GITHUB_OUTPUT
          fi

      - name: Determine today's focus
        id: focus
        run: |
          if [ -n "${{ github.event.inputs.focus_topic }}" ]; then
            echo "topic=${{ github.event.inputs.focus_topic }}" >> $GITHUB_OUTPUT
          else
            # Rotate: Day 1=phonics, Day 2=maths, Day 3=reading, repeat
            day=${{ steps.day.outputs.number }}
            case $(( day % 3 )) in
              1) echo "topic=phonics" >> $GITHUB_OUTPUT ;;
              2) echo "topic=maths" >> $GITHUB_OUTPUT ;;
              0) echo "topic=reading" >> $GITHUB_OUTPUT ;;
            esac
          fi

      - name: Determine phonics letter
        id: letter
        run: |
          # Phonics progression: S, A, T, P, I, N, M, D, G, O, C, K, E, U, R, H, B, F, L
          letters=("S" "A" "T" "P" "I" "N" "M" "D" "G" "O" "C" "K" "E" "U" "R" "H" "B" "F" "L")
          day=${{ steps.day.outputs.number }}
          # Change letter every 3 days
          index=$(( (day - 1) / 3 % ${#letters[@]} ))
          echo "current=${letters[$index]}" >> $GITHUB_OUTPUT

      - name: Read curriculum files
        id: curriculum
        run: |
          echo "reading<<EOF" >> $GITHUB_OUTPUT
          cat curriculum/reading.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "phonics<<EOF" >> $GITHUB_OUTPUT
          cat curriculum/phonics.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "maths<<EOF" >> $GITHUB_OUTPUT
          cat curriculum/maths.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate lesson plan issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "ğŸ“š Day ${{ steps.day.outputs.number }} Lesson Plan â€” Focus: ${{ steps.focus.outputs.topic }} | Letter: ${{ steps.letter.outputs.current }}"
          content-filepath: .github/prompts/lesson-plan-template.md
          labels: |
            lesson-plan
            ${{ steps.focus.outputs.topic }}
            day-${{ steps.day.outputs.number }}

      - name: Create lesson plan content
        run: |
          cat > /tmp/lesson-plan.md << 'LESSON_EOF'
          ## ğŸ“š Day ${{ steps.day.outputs.number }} â€” Little Learner Lesson Plan

          **Focus:** ${{ steps.focus.outputs.topic }} | **Letter of the Day:** ${{ steps.letter.outputs.current }} | **Duration:** 20 minutes

          ---

          > ğŸ¤– **Parent Note:** This is an auto-generated lesson framework. Use the Copilot Chat agent (`@little-learner-planner`) for a fully personalized plan with specific scenarios and activities!

          ### Teaching Steps
          1. **Letter Sounds** â€” Practice the "${{ steps.letter.outputs.current }}" sound with fun associations
          2. **Counting** â€” Count objects around the house (target: count to 10)
          3. **Storytime** â€” Read a favorite book and ask questions

          ### Suggested Activities (6 Ã— ~3 min each)

          | # | Type | Activity |
          |---|------|----------|
          | 1 | ğŸ”¤ Phonics | Find 3 objects that start with the "${{ steps.letter.outputs.current }}" sound |
          | 2 | ğŸ”¢ Maths | Count your fingers â€” how many on each hand? |
          | 3 | ğŸ“– Reading | Read a book together â€” ask "What happened?" after each page |
          | 4 | ğŸ® Game | Play "I Spy" â€” "I spy something that starts with ${{ steps.letter.outputs.current }}!" |
          | 5 | ğŸ”¢ Number Hunt | Find groups of objects and count them (shoes, spoons, toys) |
          | 6 | ğŸµ Rhyming | Think of words that rhyme (cat/bat/hat, sun/fun/run) |

          ### ğŸ“ Worksheets
          - **Letter ${{ steps.letter.outputs.current }} Tracing**: https://www.k5learning.com/free-preschool-kindergarten-worksheets/letters-of-the-alphabet
          - **Counting 1-10**: https://www.k5learning.com/free-preschool-kindergarten-worksheets/numbers-counting
          - **More worksheets**: See [resources/worksheet-sources.md](../resources/worksheet-sources.md)

          ---
          *Generated by Little Learner Planner ğŸ“ | [Get a personalized plan â†’](https://github.com/microsoft/little-learner-planner)*
          LESSON_EOF

      - name: Create issue with lesson plan
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "ğŸ“š Day ${{ steps.day.outputs.number }} Lesson Plan â€” Focus: ${{ steps.focus.outputs.topic }} | Letter: ${{ steps.letter.outputs.current }}" \
            --body-file /tmp/lesson-plan.md \
            --label "lesson-plan,${{ steps.focus.outputs.topic }}"
